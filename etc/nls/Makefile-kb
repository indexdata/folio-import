wd=/home/konchaled/folio-import
data=/data/konchaled
ref=$(data)/ref
uref=$(ref)/usr
iref=$(ref)/inv
oref=$(ref)/acq
idir=$(data)/inv
udir=$(data)/users
odir=$(data)/orders
cdir=$(data)/circ
inv2=$(wd)/inventory2
acq=$(wd)/acquisitions
con=$(inv2)/conf/nls-kb.json
ldir=$(data)/log
etc=$(wd)/etc/nls
z103=$(data)/z103.seqaa

setup:
	cd $(wd); node migrationRef.js $(ref)
	cd $(iref); rm *.tsv; ln -s $(etc)/*.tsv .

instances:
	cd $(inv2); node marc2inst-nls.js $(con) $(idir)/bibs.mrc > $(ldir)/makeInst.log 2>$(ldir)/makeInst.err &

items:
	cd $(inv2); node --max-old-space-size=4096 holdingsItems-nls.js $(con) $(idir)/bibs.map > $(ldir)/makeHoldingsItems.log 2>$(ldir)/makeHoldingsItems.err &

suppress:
	cd $(inv2); node --max-old-space-size=4096 suppressInst-nls.js $(idir)/bibs-suppress.jsonl

inventory-prep:
	cd $(idir); cat bibs-xholdings.jsonl >> bibs-holdings.jsonl
	cd $(inv2); node --max-old-space-size=4096 suppressInst-nls.js "$(idir)/bibs-suppress.jsonl"
	cd $(idir); split -n l/2 bibs-instances.jsonl in
	cd $(idir); split -n l/2 bibs-srs.jsonl sr
	cd $(idir); split -n l/2 bibs-holdings.jsonl ho
	cd $(idir); split -n l/2 bibs-items.jsonl it

users:
	cd $(wd)/patrons; node nlsUsers.js $(uref) $(udir) > $(ldir)/makeUsers.log 2>$(ldir)/makeUsers.err
	cat $(ldir)/makeUsers.log

orders:
	cd $(acq); node --max-old-space-size=4096 nlsOrders $(oref) $(z103) $(idir)/bibs-instances.jsonl $(odir) > $(ldir)/makeOrders.log 2>$(ldir)/makeOrders.err &
	tail -f $(ldir)/makeOrders.log

circ:
	cd $(wd)/patrons; DEBUG=1 node nlsCirc $(iref)/service-points.json $(cdir)/users.jsonl $(idir)/bibs-items.jsonl $(cdir)/z36.dsv $(cdir)/z37.dsv > $(ldir)/makeCirc.log
	cat $(ldir)/makeCirc.log
