wd=/home/konchaled/folio-import
data=/data/konchaled
ref=$(data)/ref
uref=$(ref)/usr
iref=$(ref)/inv
oref=$(ref)/acq
idir=$(data)/inv
udir=$(data)/users
odir=$(data)/orders
cdir=$(data)/circ
inv2=$(wd)/inventory2
acq=$(wd)/acquisitions
con=$(inv2)/conf/nls-kb.json
ldir=$(data)/log
etc=$(wd)/etc/nls
z103=$(data)/z103.seqaa

setup:
	cd $(wd); git pull
	cd $(wd); node migrationRef.js $(ref)
	cd $(iref); rm *.tsv; ln -s $(etc)/*.tsv .

instances:
	cd $(inv2); node --max-old-space-size=4096 marc2inst-nls.js $(con) $(idir)/bibs.mrc > $(ldir)/makeInst.log 2>$(ldir)/makeInst.err &

items:
	cd $(inv2); node --max-old-space-size=4096 holdingsItems-nls.js $(con) $(idir)/bibs.map > $(ldir)/makeHoldingsItems.log 2>$(ldir)/makeHoldingsItems.err &

suppress:
	cd $(inv2); node --max-old-space-size=4096 suppressInst-nls.js $(idir)/bibs-suppress.jsonl

inventory-prep:
	cd $(idir); cat bibs-xitems.jsonl >> bibs-items.jsonl
	# cd $(inv2); node --max-old-space-size=4096 suppressInst-nls.js "$(idir)/bibs-suppress.jsonl"
	cd $(idir); split -n l/2 bibs-instances.jsonl in
	# cd $(idir); split -n l/2 bibs-srs.jsonl sr
	cd $(idir); split -n l/2 bibs-holdings.jsonl ho
	cd $(idir); split -n l/2 bibs-items.jsonl it

users:
	cd $(wd)/patrons; node nlsUsers.js $(uref) $(udir) > $(ldir)/makeUsers.log 2>$(ldir)/makeUsers.err &
	tail -f $(ldir)/makeUsers.log 

split-users: $(udir)/users-users.jsonl
	cd $(udir); rm -f *-a?
	cd $(udir); split -l 15000 users-users.jsonl users-
	cd $(udir); split -l 15000 users-perms.jsonl perms-
	cd $(udir); split -l 15000 users-request-prefs.jsonl prefs-
	cd $(udir); split -l 10000 users-notes.jsonl notes-
	ls -l $(udir)

orders:
	cd $(acq); node --max-old-space-size=4096 nlsOrders $(oref) $(z103) $(idir)/bibs-instances.jsonl $(odir) > $(ldir)/makeOrders.log 2>$(ldir)/makeOrders.err &
	tail -f $(ldir)/makeOrders.log

serials:
	cd $(wd); node downloadJSONL orders-storage/titles $(odir)/titles.jsonl
	cd $(acq); node nlsSerials $(odir)/z08.dsv 1 > $(ldir)/makeSerials.log 2>$(ldir)/makeSerials.err
	cat $(ldir)/makeSerials.log

rulesets:
	cd $(acq); node nlsRuleSets $(odir)

circ:
	cd $(cdir); mv -f z36.seqaa z36.dsv; true; mv -f z37.seqaa z37.dsv; true; mv -f z310.seqaa z310.dsv
	cd $(wd); [ -f $(cdir)/users.jsonl ] || node downloadJSONL 'users?limit=5000&query=barcode==* sortBy id' $(cdir)/users.jsonl
	cd $(wd)/patrons; node --max-old-space-size=5120 nlsCirc $(iref)/service-points.json $(cdir)/users.jsonl $(idir)/bibs-items.jsonl $(cdir)/z36.dsv $(cdir)/z310.dsv $(cdir)/z37.dsv > $(ldir)/makeCirc.log 2>$(ldir)/makeCirc.err &
	tail -f $(ldir)/makeCirc.log

split-circ: $(cdir)/checkouts.jsonl
	cd $(cdir); split -l 1500 checkouts.jsonl chk
	cd $(cdir); split -l 1500 reading-room.jsonl rrchk

clean-circ: $(cdir)/*.dsv
	cd $(cdir); mv z36.dsv z36.seqaa
	cd $(cdir); mv z37.dsv z37.seqaa
	cd $(cdir); mv z310.dsv z310.seqaa

